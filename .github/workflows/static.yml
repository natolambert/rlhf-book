name: Build and Deploy to Netlify

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pandoc
        uses: pandoc/actions/setup@main
        with:
          version: 3.7.0.2

      - name: Prepare TeX Live cache directory
        run: sudo mkdir -p /usr/local/texlive && sudo chown -R $(whoami) /usr/local/texlive

      - name: Cache TeX Live
        uses: actions/cache@v4
        id: cache-texlive
        with:
          path: /usr/local/texlive
          key: texlive-macos-${{ hashFiles('.github/workflows/static.yml') }}

      - name: Install brew dependencies
        run: |
          # brew update # (slow) uncomment this for minor version updates if needed to debug other issues
          brew install make
          brew install pandoc-crossref
          brew install poppler
          # Only install TeX if not cached
          if [ "${{ steps.cache-texlive.outputs.cache-hit }}" != "true" ]; then
            echo "Cache miss - installing TeX Live..."
            brew install --cask basictex
            eval "$(/usr/libexec/path_helper)"
            sudo tlmgr update --self
            # Install pdflatex packages (comes with basictex, but ensure dependencies)
            sudo tlmgr install collection-fontsrecommended collection-latexextra standalone
          else
            echo "Cache hit - skipping TeX Live installation"
          fi

      - name: Set up LaTeX PATH
        run: |
          # Find the actual texlive bin directory (varies by year/arch)
          TEXLIVE_BIN=$(find /usr/local/texlive -type d -name "bin" -exec find {} -type d -name "*-darwin" \; 2>/dev/null | head -1)
          echo "Found TeX Live bin: $TEXLIVE_BIN"
          echo "$TEXLIVE_BIN" >> $GITHUB_PATH
          # Also add the standard symlink path in case it exists
          echo "/Library/TeX/texbin" >> $GITHUB_PATH

      - name: Clean build directory
        run: |
          rm -rf build
          mkdir -p build/html

      - name: Build book (HTML, PDF, EPUB, Kindle)
        run: |
          make
          make files

      # TODO: Add teach slide build + hosting on rlhfbook.com
      # Will need a separate workflow with path filters (teach/**)
      # - name: Build teaching slides
      #   run: |
      #     uv pip install colloquium
      #     make teach

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3
        with:
          publish-dir: './build/html'
          production-branch: main
          # Only deploy to production on push to main, not on PRs
          production-deploy: ${{ github.event_name == 'push' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions - ${{ github.sha }}"
          enable-pull-request-comment: true
          enable-commit-comment: false
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

# =============================================================================
# SETUP INSTRUCTIONS
# =============================================================================
# To enable Netlify deployment:
#
# 1. Create a Netlify site:
#    - Go to netlify.com > Add new site > Import from GitHub
#    - Select natolambert/rlhf-book
#    - IMPORTANT: Cancel the initial build (we deploy via this workflow)
#
# 2. Get your Netlify credentials:
#    - Site ID: Site settings > General > Site ID
#    - Auth Token: User settings > Applications > New access token
#
# 3. Add secrets to GitHub:
#    - Go to repo Settings > Secrets and variables > Actions
#    - Add NETLIFY_SITE_ID (the site ID from step 2)
#    - Add NETLIFY_AUTH_TOKEN (the access token from step 2)
#
# 4. Update DNS:
#    - In Netlify: Domain settings > Add custom domain > rlhfbook.com
#    - Update your DNS records to point to Netlify
#
# =============================================================================

# =============================================================================
# LEGACY: GITHUB PAGES DEPLOYMENT
# =============================================================================
# To switch back to GitHub Pages, replace the "Deploy to Netlify" step with:
#
#     - name: Setup Pages
#       uses: actions/configure-pages@v5
#
#     - name: Upload artifact
#       uses: actions/upload-pages-artifact@v3
#       with:
#         path: 'build/html/'
#
#     - name: Deploy to GitHub Pages
#       id: deployment
#       uses: actions/deploy-pages@v4
#
# And add to the job:
#     environment:
#       name: github-pages
#       url: ${{ steps.deployment.outputs.page_url }}
#
# And add at workflow level:
#   permissions:
#     contents: read
#     pages: write
#     id-token: write
#
# Then: repo Settings > Pages > Source: GitHub Actions
# =============================================================================
